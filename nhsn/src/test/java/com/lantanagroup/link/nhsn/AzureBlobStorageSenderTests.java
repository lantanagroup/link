package com.lantanagroup.link.nhsn;

import ca.uhn.fhir.context.FhirContext;
import com.lantanagroup.link.FhirContextProvider;
import com.lantanagroup.link.FhirDataProvider;
import com.lantanagroup.link.config.sender.AzureBlobStorageConfig;
import org.apache.commons.io.IOUtils;
import org.hl7.fhir.r4.model.Attachment;
import org.hl7.fhir.r4.model.DocumentReference;
import org.hl7.fhir.r4.model.MeasureReport;
import org.junit.Test;

import java.io.IOException;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.List;

import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;


public class AzureBlobStorageSenderTests {
  String serializedData = "{\"resourceType\":\"Bundle\",\"meta\":{\"profile\":[\"https://www.lantanagroup.com/fhir/StructureDefinition/measure-report-bundle\"],\"tag\":[{\"system\":\"https://nhsnlink.org\",\"code\":\"report\",\"display\":\"Report\"}]},\"identifier\":{\"system\":\"urn:ietf:rfc:3986\",\"value\":\"d2076f7a-53cf-4312-83d9-a45f9e8f2343\"},\"type\":\"collection\",\"timestamp\":\"2022-09-02T14:55:13.481+00:00\",\"entry\":[{\"fullUrl\":\"http://nhsnlink.org/fhir/MeasureReport/1847296829\",\"resource\":{\"resourceType\":\"MeasureReport\",\"id\":\"1847296829\",\"contained\":[{\"resourceType\":\"List\",\"id\":\"initial-population-subject-list\",\"status\":\"current\",\"mode\":\"snapshot\",\"entry\":[{\"item\":{\"reference\":\"MeasureReport/1847296829-896433306\"}},{\"item\":{\"reference\":\"MeasureReport/1847296829-896433302\"}},{\"item\":{\"reference\":\"MeasureReport/1847296829-896433304\"}},{\"item\":{\"reference\":\"MeasureReport/1847296829-896433272\"}}]}],\"status\":\"complete\",\"type\":\"subject-list\",\"measure\":\"http://nhsnlink.org/fhir/Measure/NHSNGlycemicControlHypoglycemicInitialPopulation\",\"period\":{\"start\":\"2022-01-01T00:00:00+00:00\",\"end\":\"2022-01-31T23:59:59+00:00\"},\"group\":[{\"population\":[{\"code\":{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/measure-population\",\"code\":\"initial-population\",\"display\":\"Initial Population\"}]},\"count\":4,\"subjectResults\":{\"reference\":\"#initial-population-subject-list\"}}]}]}},{\"fullUrl\":\"http://nhsnlink.org/fhir/List/46307166-4fee-4d5e-9cf4-ea23cd8f2c10\",\"resource\":{\"resourceType\":\"List\",\"id\":\"46307166-4fee-4d5e-9cf4-ea23cd8f2c10\",\"meta\":{\"versionId\":\"1\",\"lastUpdated\":\"2022-09-02T08:08:31.909-04:00\",\"source\":\"#hSSt3hyvBUodstFH\"},\"extension\":[{\"url\":\"https://www.lantanagroup.com/fhir/StructureDefinition/link-patient-list-applicable-period\",\"valuePeriod\":{\"start\":\"2022-01-01T00:00:00.000Z\",\"end\":\"2022-01-31T23:59:59.000Z\"}}],\"identifier\":[{\"system\":\"https://nhsnlink.org\",\"value\":\"nhsnglycemiccontrolhypoglycemicinitialpopulation\"}],\"status\":\"current\",\"mode\":\"working\",\"entry\":[{\"item\":{\"reference\":\"Patient/nhsn-iip-ip103\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip105\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip111\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip112\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip114\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip115\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip116\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip117\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip118\"}},{\"item\":{\"reference\":\"Patient/nhsn-iip-ip140\"}},{\"item\":{\"identifier\":{\"system\":\"urn:oid:2.16.840.1.113883.6.1000\",\"value\":\"123456001\"}}}]}},{\"fullUrl\":\"http://nhsnlink.org/fhir/MeasureReport/1847296829-896433306\",\"resource\":{\"resourceType\":\"MeasureReport\",\"id\":\"1847296829-896433306\",\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"nhsn-iip-ip116\",\"gender\":\"female\",\"birthDate\":\"1966-10-02\"}],\"extension\":[{\"url\":\"http://hl7.org/fhir/5.0/StructureDefinition/extension-MeasureReport.population.description\",\"valueString\":\"All inpatient encounters (including ED/Observation visits that end within 1 hour of the start of the inpatient encounter) for patients of all ages where at least one ADD was ordered or administered during the encounter that is during the measurement period.\"},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-supplementalData\",\"valueReference\":{\"extension\":[{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-medication-request\"},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-minimal-medication-requests\"}],\"reference\":\"MedicationRequest/nhsn-iip-add116\"}},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-supplementalData\",\"valueReference\":{\"extension\":[{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-minimal-patient\"}],\"reference\":\"#nhsn-iip-ip116\"}}],\"status\":\"complete\",\"type\":\"individual\",\"measure\":\"http://nhsnlink.org/fhir/Measure/NHSNGlycemicControlHypoglycemicInitialPopulation\",\"subject\":{\"reference\":\"Patient/nhsn-iip-ip116\"},\"date\":\"2022-09-02T12:09:31+00:00\",\"period\":{\"start\":\"2022-01-01T00:00:00+00:00\",\"end\":\"2022-01-31T23:59:59+00:00\"},\"group\":[{\"population\":[{\"extension\":[{\"url\":\"http://hl7.org/fhir/5.0/StructureDefinition/extension-MeasureReport.population.description\",\"valueString\":\"All inpatient encounters, as well as ED and OBS encounters that end within 1 hour of the start of the inpatient encounter, for patients of all ages where at least one antidiabetic drug (ADD) was ordered or administered during the encounter that is during the measurement period.\"}],\"code\":{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/measure-population\",\"code\":\"initial-population\",\"display\":\"Initial Population\"}]},\"count\":1}]}]}},{\"fullUrl\":\"http://nhsnlink.org/fhir/MeasureReport/1847296829-896433302\",\"resource\":{\"resourceType\":\"MeasureReport\",\"id\":\"1847296829-896433302\",\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"nhsn-iip-ip112\",\"gender\":\"female\",\"birthDate\":\"1942-03-30\"}],\"extension\":[{\"url\":\"http://hl7.org/fhir/5.0/StructureDefinition/extension-MeasureReport.population.description\",\"valueString\":\"All inpatient encounters (including ED/Observation visits that end within 1 hour of the start of the inpatient encounter) for patients of all ages where at least one ADD was ordered or administered during the encounter that is during the measurement period.\"},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-supplementalData\",\"valueReference\":{\"extension\":[{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-medication-request\"},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-minimal-medication-requests\"}],\"reference\":\"MedicationRequest/nhsn-iip-add112\"}},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-supplementalData\",\"valueReference\":{\"extension\":[{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-minimal-patient\"}],\"reference\":\"#nhsn-iip-ip112\"}}],\"status\":\"complete\",\"type\":\"individual\",\"measure\":\"http://nhsnlink.org/fhir/Measure/NHSNGlycemicControlHypoglycemicInitialPopulation\",\"subject\":{\"reference\":\"Patient/nhsn-iip-ip112\"},\"date\":\"2022-09-02T12:09:31+00:00\",\"period\":{\"start\":\"2022-01-01T00:00:00+00:00\",\"end\":\"2022-01-31T23:59:59+00:00\"},\"group\":[{\"population\":[{\"extension\":[{\"url\":\"http://hl7.org/fhir/5.0/StructureDefinition/extension-MeasureReport.population.description\",\"valueString\":\"All inpatient encounters, as well as ED and OBS encounters that end within 1 hour of the start of the inpatient encounter, for patients of all ages where at least one antidiabetic drug (ADD) was ordered or administered during the encounter that is during the measurement period.\"}],\"code\":{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/measure-population\",\"code\":\"initial-population\",\"display\":\"Initial Population\"}]},\"count\":1}]}]}},{\"fullUrl\":\"http://nhsnlink.org/fhir/MeasureReport/1847296829-896433304\",\"resource\":{\"resourceType\":\"MeasureReport\",\"id\":\"1847296829-896433304\",\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"nhsn-iip-ip114\",\"gender\":\"female\",\"birthDate\":\"1954-07-07\"}],\"extension\":[{\"url\":\"http://hl7.org/fhir/5.0/StructureDefinition/extension-MeasureReport.population.description\",\"valueString\":\"All inpatient encounters (including ED/Observation visits that end within 1 hour of the start of the inpatient encounter) for patients of all ages where at least one ADD was ordered or administered during the encounter that is during the measurement period.\"},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-supplementalData\",\"valueReference\":{\"extension\":[{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-medication-request\"},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-minimal-medication-requests\"}],\"reference\":\"MedicationRequest/nhsn-iip-add114\"}},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-supplementalData\",\"valueReference\":{\"extension\":[{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-minimal-patient\"}],\"reference\":\"#nhsn-iip-ip114\"}}],\"status\":\"complete\",\"type\":\"individual\",\"measure\":\"http://nhsnlink.org/fhir/Measure/NHSNGlycemicControlHypoglycemicInitialPopulation\",\"subject\":{\"reference\":\"Patient/nhsn-iip-ip114\"},\"date\":\"2022-09-02T12:09:31+00:00\",\"period\":{\"start\":\"2022-01-01T00:00:00+00:00\",\"end\":\"2022-01-31T23:59:59+00:00\"},\"group\":[{\"population\":[{\"extension\":[{\"url\":\"http://hl7.org/fhir/5.0/StructureDefinition/extension-MeasureReport.population.description\",\"valueString\":\"All inpatient encounters, as well as ED and OBS encounters that end within 1 hour of the start of the inpatient encounter, for patients of all ages where at least one antidiabetic drug (ADD) was ordered or administered during the encounter that is during the measurement period.\"}],\"code\":{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/measure-population\",\"code\":\"initial-population\",\"display\":\"Initial Population\"}]},\"count\":1}]}]}},{\"fullUrl\":\"http://nhsnlink.org/fhir/MeasureReport/1847296829-896433272\",\"resource\":{\"resourceType\":\"MeasureReport\",\"id\":\"1847296829-896433272\",\"contained\":[{\"resourceType\":\"Patient\",\"id\":\"nhsn-iip-ip103\",\"gender\":\"male\",\"birthDate\":\"1955-11-11\"}],\"extension\":[{\"url\":\"http://hl7.org/fhir/5.0/StructureDefinition/extension-MeasureReport.population.description\",\"valueString\":\"All inpatient encounters (including ED/Observation visits that end within 1 hour of the start of the inpatient encounter) for patients of all ages where at least one ADD was ordered or administered during the encounter that is during the measurement period.\"},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-supplementalData\",\"valueReference\":{\"extension\":[{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-medication-request\"},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-minimal-medication-requests\"}],\"reference\":\"MedicationRequest/nhsn-iip-add103\"}},{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-supplementalData\",\"valueReference\":{\"extension\":[{\"url\":\"http://hl7.org/fhir/us/davinci-deqm/StructureDefinition/extension-criteriaReference\",\"valueString\":\"sde-minimal-patient\"}],\"reference\":\"#nhsn-iip-ip103\"}}],\"status\":\"complete\",\"type\":\"individual\",\"measure\":\"http://nhsnlink.org/fhir/Measure/NHSNGlycemicControlHypoglycemicInitialPopulation\",\"subject\":{\"reference\":\"Patient/nhsn-iip-ip103\"},\"date\":\"2022-09-02T12:09:31+00:00\",\"period\":{\"start\":\"2022-01-01T00:00:00+00:00\",\"end\":\"2022-01-31T23:59:59+00:00\"},\"group\":[{\"population\":[{\"extension\":[{\"url\":\"http://hl7.org/fhir/5.0/StructureDefinition/extension-MeasureReport.population.description\",\"valueString\":\"All inpatient encounters, as well as ED and OBS encounters that end within 1 hour of the start of the inpatient encounter, for patients of all ages where at least one antidiabetic drug (ADD) was ordered or administered during the encounter that is during the measurement period.\"}],\"code\":{\"coding\":[{\"system\":\"http://terminology.hl7.org/CodeSystem/measure-population\",\"code\":\"initial-population\",\"display\":\"Initial Population\"}]},\"count\":1}]}]}}]}";

  @Test
  public void send() throws Exception {

    AzureBlobStorageConfig config = new AzureBlobStorageConfig();
    AzureBlobStorageSender mockSender = new AzureBlobStorageSender();

    DocumentReference documentReference = new DocumentReference();
    FhirDataProvider mockFhirDataProvider = mock(FhirDataProvider.class);
    when(mockFhirDataProvider.findDocRefForReport(anyString())).thenReturn(documentReference);

    Attachment attachment = new Attachment();
    DocumentReference.DocumentReferenceContentComponent documentReferenceContentComponent = new DocumentReference.DocumentReferenceContentComponent();
    documentReferenceContentComponent.setAttachment(attachment);
    List<DocumentReference.DocumentReferenceContentComponent> referenceContentComponents = new ArrayList<>();
    referenceContentComponents.add(documentReferenceContentComponent);
    documentReference.setContent(referenceContentComponents);

    MeasureReport measureReport = getMasterMeasureReport();
    mockSender.updateDocumentLocation(measureReport, mockFhirDataProvider, "www.testLocation.com");

    //not sure how to approach this after this point

  }


  private MeasureReport getMasterMeasureReport() throws IOException {
    String measureReportJson = IOUtils.toString(this.getClass().getClassLoader().getResourceAsStream("fhir-sender-master-measure-report.json"), Charset.defaultCharset());
    FhirContext ctx = FhirContextProvider.getFhirContext();
    return ctx.newJsonParser().parseResource(MeasureReport.class, measureReportJson);
  }

}
